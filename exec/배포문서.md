# ë°°í¬ ë¬¸ì„œ

## ğŸ› ï¸1. ì‹œìŠ¤í…œ í™˜ê²½

### **AWS EC2**

Ubuntu 20.04 LTS

Jenkins 2.334

Nginx 1.18.0

Docker 20.10.12

Docker-compose 1.28.5

### **Database**

MySQL 8.0.28

AWS S3 (Image Server)

## ğŸ‘‘2. ê¸°ìˆ  ìŠ¤íƒ

### **Frontend**

IDE: VSCode

Node JS 16.13.x

Language: HTML5, Javascript, CSS3

Library: React 17.0.2, SCSS, TypeScript, Axios, Redux, Stompjs, Sockjs

Open API: Web Speech API

Framework: Material-UI

### **Backend**

IDE: IntelliJ 2021.3.1

Language: Java 1.8

Framework: Spring Boot 2.4.5

Library: JWT, Spring-Boot-JPA,Spring Security, Stomp, Resttemplate

Open API: SNS ë¡œê·¸ì¸(kakao, google), ìš°ë¦¬ë§ ìƒ˜

## ğŸ·3. MOYOBAR **ë°°í¬ ìˆœì„œ**

1. MOYOBARë¥¼ Git Clone í•©ë‹ˆë‹¤.
2. nginxë¥¼ ì„¤ì¹˜ í›„ ì„¤ì •í•´ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì—­í• ì„ í•˜ë„ë¡ í•©ë‹ˆë‹¤.
3. mysqlì„ docker-composeë¥¼ ì´ìš©í•´ ë¹Œë“œ í›„ ì‹¤í–‰ ì‹œí‚µë‹ˆë‹¤.
4. openviduë¥¼ ì„¤ì¹˜í•´ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.
5. frontendë¥¼ ë¹Œë“œ í•˜ì—¬ nginxì™€ ë¹Œë“œëœ íŒŒì¼ì„ ì´ë¯¸ì§€í™” ì‹œì¼œ ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“­ë‹ˆë‹¤.
6. backendë¥¼ ë¹Œë“œ í•˜ì—¬ ë°°í¬ íŒŒì¼ì¸ jar íŒŒì¼ì„ ìƒì„±í•´ docker-composeë¥¼ í†µí•´ ì´ë¯¸ì§€í™” í›„ ì»¨í…Œì´ë„ˆë¡œ ë§Œë“­ë‹ˆë‹¤.
7. ìœ„ì— ë§Œë“  ì»¨í…Œì´ë„ˆë“¤ì„ ì‹¤í–‰ì‹œì¼œ ë°°í¬í•©ë‹ˆë‹¤.
8. Jenkinsë¥¼ ì´ìš©í•´ 4, 5, 6ë²ˆì„ ìë™ìœ¼ë¡œ ë¹Œë“œí•˜ì—¬ ë°°í¬í•©ë‹ˆë‹¤.

## ğŸ¹4. Nginx

ì›¹ì„œë²„ì™€ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì—­í• ì„ í•˜ëŠ” nginxë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

**Nginx ì„¤ì¹˜**

```bash
$ sudo apt install nginx
```

1. MOYOBAR í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì„¤ì •íŒŒì¼ì„ ë§Œë“¤ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•©ë‹ˆë‹¤.

```bash
$ vi /etc/nginx/sites-available/í”„ë¡œì íŠ¸ëª…
```

```xml
server {

        location /{ # í”„ë¡ íŠ¸ì•¤ë“œ
                proxy_pass http://localhost:3000;
        }

        location /api { # ë°±ì—”ë“œ
                proxy_pass http://localhost:8080/api;
        }

        location /moyobar{
								# ë°±ì—”ë“œì˜ ì†Œì¼“í†µì‹ ì„ ìœ„í•œ ê²½ë¡œ
                proxy_pass http://localhost:8080/moyobar;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "Upgrade";
        }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/i6d210.p.ssafy.io/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/i6d210.p.ssafy.io/privkey.pem; # managed by Certbot
    # include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = i6d210.p.ssafy.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

        listen 80;
        server_name i6d210.p.ssafy.io;
    return 404; # managed by Certbot
}
```

1. ì €ì¥ í›„, í•´ë‹¹ íŒŒì¼ì˜ ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ë‹¤ìŒ ê²½ë¡œì— ì¶”ê°€í•©ë‹ˆë‹¤.

```bash
$ ln -s /etc/nginx/sites-available/í”„ë¡œì íŠ¸ëª… /etc/nginx/sites-enabled/í”„ë¡œì íŠ¸ëª…
```

1. ì˜¬ë°”ë¥¸ ë¬¸ë²•ì¸ì§€ ê²€ì‚¬í•˜ê³ , ë‹¤ì‹œ ì¬ì‹¤í–‰ í•©ë‹ˆë‹¤.

```bash
$ sudo nginx -t
$ sudo service nginx restart
$ sudo systemctl status nginx
```

1. ë‹¨, HTTPSë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤. ì¸ì¦ì„œëŠ” ìµœì´ˆ 1íšŒë§Œ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.

```bash
$ sudo apt-get install letsencrypt
$ sudo letsencrypt certonly --standalone -d i6d210.p.ssafy.io
```

## ğŸ“·5. OpenVidu

WebRTCë¥¼ ì´ìš©í•œ í™”ìƒíšŒì˜ë¥¼ ì´ìš©í•˜ê¸° ìœ„í•´ OpenViduë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

ì„¤ì¹˜ì™€ ì‚¬ìš©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

**OpenVidu ì„¤ì¹˜**

```bash
cd /opt   # openviduëŠ” /opt ë””ë ‰í† ë¦¬ì— ì„¤ì¹˜ë˜ëŠ”ê²Œ ê¶Œì¥
sudo curl https://s3-eu-west-1.amazonaws.com/aws.openvidu.io/install_openvidu_latest.sh | sudo bash
```

**OpenVidu ì„¤ì •íŒŒì¼**

```bash
cd /opt # openviduëŠ” /opt ë””ë ‰í† ë¦¬ì— ì„¤ì¹˜ë˜ëŠ”ê²Œ ê¶Œì¥
sudo vi .env
DOMAIN_OR_PUBLIC_IP=<Linux ì„œë²„ì˜ public ip ì£¼ì†Œ ë˜ëŠ” ë„ë©”ì¸>
OPENVIDU_SECRET=<ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥>
CERTIFICATE_TYPE=letsencrypt # default ê°’ì€ selfsignedì§€ë§Œ selfsigned ë°©ì‹ ì‚¬ìš©ì‹œ ë³´ì•ˆ ë¬¸ì œë¥¼ ì•¼ê¸°
							 # SSL í‚¤ê°€ ìˆë‹¤ë©´ owncert ë°©ì‹ìœ¼ë¡œ í•˜ë˜, /owncert ë””ë ‰í† ë¦¬ ì•ˆì— í‚¤ê°€ ìˆì–´ì•¼ í•¨
LETSENCRYPT_EMAIL=<ì´ë©”ì¼>
HTTP_PORT=80
HTTPS_PORT=443
# HTTP_PORTì™€ HTTPS_PORTëŠ” letsencrypt ë°©ì‹ì˜ í‚¤ë¥¼ ë°œê¸‰ ë°›ê¸° ì „ê¹Œì§„ ê¸°ë³¸ í¬íŠ¸ì¸ 80, 443ì„ ì‚¬ìš©í•´ì•¼ í•¨.
# í‚¤ë¥¼ ë°œê¸‰ë°›ê³  ë‚œ í›„ë¶€í„°ëŠ” í¬íŠ¸ ë³€ê²½í•´ë„ ë¬´ë°©
```

**OpenVidu ì‹¤í–‰**

```bash
cd /opt/openvidu
sudo ./openvidu start
```

## ğŸ“¦6. dockerì™€ docker-compose

ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì»¨í…Œì´ë„ˆì— ë‹´ì•„ ë°°í¬í•˜ê¸° ìœ„í•´ dockerë¥¼ ì‚¬ìš©í–ˆê³ , ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë“¤ì„ í•œêº¼ë²ˆì— ê´€ë¦¬í•˜ê¸° ìœ„í•´ docker-composeë¥¼ ê°™ì´ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

**docker ì„¤ì¹˜ ë°©ë²•**

```bash
$ sudo apt-get update
$ sudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
$ echo \
  "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
$ sudo apt-get update
$ sudo apt-get install docker-ce docker-ce-cli containerd.io
```

**docker ì‚¬ìš© ì˜ˆì‹œ**

```bash
docker run -itd --name jenkins -p 8080:8080 -p 50000:50000 \
-v /docker/jenkins:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock \
-e TZ=Asia/Seoul -u root jenkins/jenkins:latest
```

**docker-compose ì„¤ì¹˜ ë°©ë²•**

```bash
$ sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
$ sudo chmod +x /usr/local/bin/docker-compose
$ sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
$ docker-compose -version
```

**docker-compose ì‚¬ìš© ì˜ˆì‹œ**

docker-compose.yml íŒŒì¼ì´ ìˆëŠ” ìœ„ì¹˜ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
$ sudo docker-compose build # ë„ì»¤ ë¹Œë“œ
$ sudo docker-compose up -d # ë°±ê·¸ë¼ìš´ë“œë¡œ ë¹Œë“œí•œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ sudo docker-compose down # docker-compose ì™€ ê´€ë ¨ëœ ì´ë¯¸ì§€, ì»¨í…Œì´ë„ˆ ì¼ê´„ ì‚­ì œ
```

**ëª¨ì—¬ë°” í”„ë¡œì íŠ¸ì˜ docker-compose.yml íŒŒì¼**

- mysql docker-compose.yml
  ```yaml
  version: "3"
  services:
    db:
      image: mysql
      container_name: mysql
      ports:
        - "3306:3306"
      environment:
        MYSQL_ALLOUW_EMPTY_PASSWORD: true
  			MYSQL_USER: moyobar
  			MYSQL_PASSWORD: {}
  			MYSQL_DATABASE: moyobardb
  		cap_add:
  			- SYS_NICE
     command: # ëª…ë ¹ì–´ ì‹¤í–‰
        - --character-set-server=utf8mb4
        - --collation-server=utf8mb4_unicode_ci
  ```
- jenkins docker-compose.yml
  ```yaml
  version: "3.1"
  services:
    jenkins:
      restart: always
      container_name: jenkins
      build:
        dockerfile: Dockerfile
        context: ./
      user: root
      ports:
        - "9090:8080"
        - "50000:50000"
      volumes:
        - ./jenkins_home:/var/jenkins_home
        - /var/run/docker.sock:/var/run/docker.sock
      environment:
        TZ: "Asia/Seoul"
  ```
- front(nginx)/back docker-compose.yml
  ```yaml
  version: "3"
  services:
    backend:
      container_name: moyobar_backend
      image: "moyobar_backend:0.1"
      build:
        dockerfile: Dockerfile
        context: ./backend
      ports:
        - "8080:8080"
      networks:
        - moyobar
      environment:
        - TZ=Asia/Seoul
    nginx:
      restart: always
      container_name: "moyobar_frontend"
      image: "moyobar_frontend:0.1"
      build:
        dockerfile: Dockerfile
        context: ./frontend
      ports:
        - "3000:80"
      networks:
        - moyobar
      environment:
        - TZ=Asia/Seoul

  networks:
    moyobar:
  ```

## ğŸ‘´ğŸ»7. Jenkins

ìœ„ì—ì„œ í•œ ì‘ì—…ë“¤ì„ ìë™í™” í•˜ëŠ” CI/CD íˆ´ë¡œ, docker ì‚¬ìš© ì˜ˆì‹œ í˜¹ì€ ìƒë‹¨ì˜ docker-compose.yml íŒŒì¼ë¡œ ì  í‚¨ìŠ¤ë¥¼ ë„ì»¤ë¡œ ë¹Œë“œí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

```bash
$ sudo docker exec jenkins cat /etc/var/jenkins_home/secrets/initialAmdinPassword
```

ìœ„ ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¡œê·¸ì¸ í›„, í•„ìš”í•œ íŒŒì´í”„ë¼ì¸ì„ ì„¤ì •í•´ GitLabê³¼ MatterMostë¥¼ ì—°ë™í•´ ì•ŒëŒì„ ë‚´ë³´ë‚´ê³ , GitLabì˜ ì´ë²¤íŠ¸ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë¹Œë“œí•˜ì—¬ ë°°í¬í•˜ë„ë¡ í•©ë‹ˆë‹¤.

## ğŸ”7. **í”„ë¡œì íŠ¸ ì†ì„± íŒŒì¼ ëª©ë¡**

DB ì •ë³´, í† í° ì •ë³´ ë° ê°ì¢… APIì˜ KEY ê°’ ë“±ì„ ë”°ë¡œ ë³´ê´€í•˜ì˜€ìŠµë‹ˆë‹¤.

í•´ë‹¹ íŒŒì¼ì€ backend/src/main/resources/application-secret.ymlì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
